<div style="min-height: 100vh; background: #f9fafb; display: flex; flex-direction: column;">
    <app-main-header [showSidebarButton]="false">
    </app-main-header>

    <div class="targets-page">
        <div class="page-header">
            <div class="header-left">
                <h2><i class="pi pi-flag"></i> Targets Management</h2>
                <p class="subtitle">Set and track monthly targets per advertiser and department</p>
            </div>
            <div class="header-actions">
                <button pButton type="button" class="p-button-success manage-targets-btn" (click)="toggleForm()">
                    Manage Targets
                </button>
            </div>
        </div>

        <!-- KPI Overview Cards -->
        <div class="kpi-overview">
            <div class="kpi-card kpi-total">
                <div class="kpi-icon">
                    <i class="pi pi-flag"></i>
                </div>
                <div class="kpi-content">
                    <span class="kpi-label">Total Targets</span>
                    <span class="kpi-value">{{stats.totalTargets}}</span>
                </div>
            </div>

            <div class="kpi-card kpi-current">
                <div class="kpi-icon">
                    <i class="pi pi-calendar"></i>
                </div>
                <div class="kpi-content">
                    <span class="kpi-label">Current Month</span>
                    <span class="kpi-value">{{stats.currentMonth}}</span>
                </div>
            </div>

            <div class="kpi-card kpi-advertisers">
                <div class="kpi-icon">
                    <i class="pi pi-briefcase"></i>
                </div>
                <div class="kpi-content">
                    <span class="kpi-label">Active Advertisers</span>
                    <span class="kpi-value">{{stats.activeAdvertisers}}</span>
                </div>
            </div>

            <div class="kpi-card kpi-departments">
                <div class="kpi-icon">
                    <i class="pi pi-sitemap"></i>
                </div>
                <div class="kpi-content">
                    <span class="kpi-label">Departments</span>
                    <span class="kpi-value">{{stats.departments}}</span>
                </div>
            </div>
        </div>

        <div class="targets-table-card">
            <div class="table-header">
                <div class="table-title">
                    <h3><i class="pi pi-list"></i> All Targets</h3>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
                <div class="filter-item">
                    <label>Quick Filter</label>
                    <button pButton type="button" label="Current Month Only"
                        [class.active-filter]="showCurrentMonthOnly" (click)="toggleCurrentMonthFilter()"
                        class="p-button-outlined quick-filter-btn"></button>
                </div>
                <div class="filter-item">
                    <label>Advertiser</label>
                    <select [(ngModel)]="filterAdvertiser" (change)="applyFilters()" class="form-input">
                        <option [value]="null">All Advertisers</option>
                        <option *ngFor="let adv of advertiserOptions" [value]="adv.value">{{ adv.label }}</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Department</label>
                    <select [(ngModel)]="filterDepartment" (change)="applyFilters()" class="form-input">
                        <option [value]="null">All Departments</option>
                        <option *ngFor="let dept of departmentOptions" [value]="dept.value">{{ dept.label }}</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Month</label>
                    <select [(ngModel)]="filterMonth" (change)="applyFilters()" class="form-input">
                        <option [value]="null">All Months</option>
                        <option *ngFor="let month of monthOptions" [value]="month.value">{{ month.label }}</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button pButton type="button" label="Clear All" (click)="clearFilters()"
                        class="p-button-secondary p-button-outlined"></button>
                </div>
            </div>

            <!-- Skeleton Loaders -->
            <div *ngIf="showSkeletons" class="skeleton-table">
                <app-skeleton-loader type="table-row"></app-skeleton-loader>
                <app-skeleton-loader type="table-row"></app-skeleton-loader>
                <app-skeleton-loader type="table-row"></app-skeleton-loader>
                <app-skeleton-loader type="table-row"></app-skeleton-loader>
                <app-skeleton-loader type="table-row"></app-skeleton-loader>
            </div>

            <p-table *ngIf="!loading" [value]="filteredTargets" [paginator]="true" [rows]="30"
                [rowsPerPageOptions]="[10,25,30,50,100]" styleClass="p-datatable-sm p-datatable-striped targets-table"
                [loading]="loading" [showCurrentPageReport]="true"
                currentPageReportTemplate="{first}-{last} of {totalRecords} records">
                <ng-template pTemplate="header">
                    <tr>
                        <th class="col-advertiser">Advertiser</th>
                        <th class="col-department">Department</th>
                        <th class="col-member">Assigned To</th>
                        <th class="col-month">Month</th>
                        <th class="col-orders">Orders Target</th>
                        <th class="col-revenue">Revenue Target</th>
                        <th class="col-profit">Profit Target</th>
                        <th class="col-actions" style="width: 140px;">Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-target>
                    <tr>
                        <td class="col-advertiser">
                            <span class="advertiser-name">{{ target.advertiser_name }}</span>
                        </td>
                        <td class="col-department">
                            <span class="department-badge">{{ target.partner_type_display }}</span>
                        </td>
                        <td class="col-member">
                            <span class="member-badge" *ngIf="target.assigned_to_username; else noDept">{{
                                target.assigned_to_username }}</span>
                            <ng-template #noDept><span style="color: #9ca3af;">Department Level</span></ng-template>
                        </td>
                        <td class="col-month">
                            <span class="month-value">{{ target.month | date: 'MMM yyyy' }}</span>
                        </td>
                        <td class="col-orders">
                            <span class="target-value">{{ target.orders_target | number }}</span>
                        </td>
                        <td class="col-revenue">
                            <span class="target-value currency">{{ target.revenue_target | currency }}</span>
                        </td>
                        <td class="col-profit">
                            <span class="target-value currency">{{ target.profit_target | currency }}</span>
                        </td>
                        <td class="actions">
                            <button class="action-btn edit-btn" (click)="editTarget(target)">
                                <i class="pi pi-pencil"></i>
                            </button>
                            <button class="action-btn delete-btn" (click)="deleteTarget(target.id!)">
                                <i class="pi pi-trash"></i>
                            </button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="8" class="empty-message">
                            <i class="pi pi-inbox"></i>
                            <p>No targets found</p>
                            <button pButton type="button" label="Create First Target" (click)="toggleForm()"
                                class="p-button-sm"></button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <!-- Target Form Dialog -->
        <p-dialog [(visible)]="showForm" [modal]="true" [style]="{width: '700px'}"
            [header]="editingTarget ? 'Edit Target' : 'Create New Target'" [draggable]="false" [resizable]="false"
            [maximizable]="false">

            <form>
                <div class="form-group">
                    <label for="advertiser">Advertiser <span class="required">*</span></label>
                    <select [(ngModel)]="formData.advertiser" name="advertiser" id="advertiser" class="form-control"
                        required>
                        <option value="">Select Advertiser</option>
                        <option *ngFor="let adv of advertisers" [value]="adv.id">{{ adv.name }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="partner_type">Department <span class="required">*</span></label>
                    <select [(ngModel)]="formData.partner_type" name="partner_type" id="partner_type"
                        class="form-control" (change)="onPartnerTypeChange(formData.partner_type)" required>
                        <option value="">Select Department</option>
                        <option value="MB">Media Buying</option>
                        <option value="AFF">Affiliate</option>
                        <option value="INF">Influencer</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="assigned_to">Assign to Team Member (Optional)</label>
                    <select [(ngModel)]="formData.assigned_to" name="assigned_to" id="assigned_to" class="form-control">
                        <option [value]="null">Leave blank for department-level target</option>
                        <option *ngFor="let member of teamMembers" [value]="member.id">{{ member.name }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="month">Month <span class="required">*</span></label>
                    <input type="month" [(ngModel)]="formData.month" name="month" id="month" class="form-control"
                        required>
                </div>

                <div class="form-group">
                    <label for="orders_target">Orders Target <span class="required">*</span></label>
                    <input type="number" [(ngModel)]="formData.orders_target" name="orders_target" id="orders_target"
                        class="form-control" min="0" required>
                </div>

                <div class="form-group">
                    <label for="revenue_target">Revenue Target <span class="required">*</span></label>
                    <input type="number" [(ngModel)]="formData.revenue_target" name="revenue_target" id="revenue_target"
                        class="form-control" min="0" step="0.01" (ngModelChange)="onRevenueChange()" required>
                </div>

                <div class="form-group">
                    <label for="spend_target">Spend Target <span class="required">*</span></label>
                    <input type="number" [(ngModel)]="formData.spend_target" name="spend_target" id="spend_target"
                        class="form-control" min="0" step="0.01" (ngModelChange)="onSpendChange()" required>
                </div>

                <div class="form-group">
                    <label for="profit_target">Profit Target (Auto-calculated)</label>
                    <input type="number" [value]="formData.profit_target" name="profit_target" id="profit_target"
                        class="form-control" min="0" step="0.01" readonly disabled
                        style="background-color: #f3f4f6; cursor: not-allowed;">
                    <small style="color: #6b7280; display: block; margin-top: 4px;">
                        <i class="pi pi-info-circle"></i> Calculated as: Revenue Target - Spend Target
                    </small>
                </div>
            </form>

            <ng-template pTemplate="footer">
                <button type="button" pButton label="Cancel" icon="pi pi-times" (click)="toggleForm()"
                    class="p-button-text"></button>
                <button type="button" pButton label="Save" icon="pi pi-check" (click)="saveTarget()"
                    class="p-button-success"></button>
            </ng-template>
        </p-dialog>

        <!-- Footer -->
        <app-footer></app-footer>
    </div>
</div>