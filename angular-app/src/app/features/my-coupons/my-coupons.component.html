<div class="my-coupons-page">
    <app-main-header></app-main-header>

    <div class="container">
        <div class="page-header">
            <h1>My Coupons</h1>
            <p>Track performance of your coupons across all campaigns</p>
        </div>

        <!-- Summary Cards -->
        <div class="kpi-grid">
            <p-card styleClass="kpi-card">
                <div class="kpi-content">
                    <i class="pi pi-tag kpi-icon"></i>
                    <div>
                        <h4>COUPONS</h4>
                        <p class="kpi-value">{{ totalCoupons }}</p>
                    </div>
                </div>
            </p-card>
            <p-card styleClass="kpi-card">
                <div class="kpi-content">
                    <i class="pi pi-shopping-cart kpi-icon"></i>
                    <div>
                        <h4>ORDERS</h4>
                        <p class="kpi-value">{{ totalOrders }}</p>
                    </div>
                </div>
            </p-card>
            <p-card styleClass="kpi-card">
                <div class="kpi-content">
                    <i class="pi pi-dollar kpi-icon"></i>
                    <div>
                        <h4>SALES</h4>
                        <p class="kpi-value">${{ totalSales | trimDecimals }}</p>
                    </div>
                </div>
            </p-card>
            <p-card styleClass="kpi-card">
                <div class="kpi-content">
                    <i class="pi pi-wallet kpi-icon"></i>
                    <div>
                        <h4>PAYOUT</h4>
                        <p class="kpi-value">${{ totalGrossPayout | trimDecimals }}</p>
                        <p class="kpi-subvalue">Net: {{ totalNetPayout !== null && totalNetPayout !== undefined ? ('$' +
                            (totalNetPayout | trimDecimals)) : '-' }}</p>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Data Table with Filters -->
        <p-card class="table-card">
            <ng-template pTemplate="header">
                <div class="table-header">
                    <div class="table-title">
                        <h3><i class="pi pi-table table-icon"></i> Coupon Performance</h3>
                        <span class="record-count">{{ totalRecords }} records</span>
                    </div>
                    <div class="table-controls">
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">Date Range</label>
                                <p-datepicker [(ngModel)]="dateRange" selectionMode="range" dateFormat="yy-mm-dd"
                                    placeholder="Select date range" [showIcon]="false" [showButtonBar]="true" 
                                    [readonlyInput]="true" (ngModelChange)="onDateRangeChange()" 
                                    styleClass="white-bg-input">
                                </p-datepicker>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Campaign</label>
                                <p-select [(ngModel)]="selectedAdvertiser" [options]="advertisers" optionLabel="name"
                                    placeholder="All Campaigns" [showClear]="true" (onChange)="applyFilters()"
                                    styleClass="white-bg-input" appendTo="body">
                                </p-select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Search Coupon</label>
                                <input pInputText [(ngModel)]="searchTerm" placeholder="Search by coupon code"
                                    (input)="onSearchChange()" class="filter-input">
                            </div>
                        </div>

                        <div class="export-buttons">
                            <p-button label="Export CSV" icon="pi pi-download" (onClick)="exportData()"
                                severity="primary" size="small" styleClass="export-btn">
                            </p-button>
                        </div>
                    </div>
                </div>
            </ng-template>

            <p-table [value]="coupons" [loading]="loading" [paginator]="false" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th class="col-coupon">Coupon</th>
                        <th class="col-orders centered">Orders</th>
                        <th class="col-amount centered">Sales</th>
                        <th class="col-amount centered">Payout</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-campaign let-rowIndex="rowIndex">
                    <!-- Campaign Header Row -->
                    <tr class="campaign-row">
                        <td colspan="4" class="campaign-header">
                            <span class="campaign-name">{{ campaign.advertiser_name }}</span>
                            <span class="coupon-count">({{ campaign.coupon_count }})</span>
                        </td>
                    </tr>
                    <!-- Coupon Rows -->
                    <tr *ngFor="let coupon of campaign.coupons; let isLast = last" class="coupon-row"
                        [class.last-in-group]="isLast">
                        <td class="col-coupon coupon-indent">{{ coupon.coupon }}</td>
                        <td class="col-orders centered">{{ coupon.orders }}</td>
                        <td class="col-amount centered">${{ coupon.sales | trimDecimals }}</td>
                        <td class="col-amount centered stacked-cell">
                            <div class="main-value">${{ coupon.gross_payout | trimDecimals }}</div>
                            <div class="sub-value">Net: {{ coupon.net_payout !== null && coupon.net_payout !== undefined
                                ? ('$' + (coupon.net_payout | trimDecimals)) : '-' }}</div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="4" class="text-center">
                            <div class="empty-message">
                                <i class="pi pi-inbox"></i>
                                <p>No coupons found</p>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <!-- Pagination -->
            <p-paginator *ngIf="totalRecords > rowsPerPage" [rows]="rowsPerPage" [totalRecords]="totalRecords"
                [first]="(currentPage - 1) * rowsPerPage" (onPageChange)="onPageChange($event)">
            </p-paginator>
        </p-card>
    </div>

    <app-footer></app-footer>
</div>